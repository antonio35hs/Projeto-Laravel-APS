#!/usr/bin/env bash
set -e

BASE_DIR="${PWD}/meu-projeto-laravel"
echo "Criando projeto em: $BASE_DIR"

mkdir -p "$BASE_DIR"

write_file() {
  local path="$1"
  local content="$2"
  mkdir -p "$(dirname "$BASE_DIR/$path")"
  cat > "$BASE_DIR/$path" <<'EOF'
'"$content"'
EOF
}

# .env.example
mkdir -p "$BASE_DIR"
cat > "$BASE_DIR/.env.example" <<'EOF'
APP_NAME="ProjetoLaravelAPS"
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

LOG_CHANNEL=stack

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=aps_db
DB_USERNAME=root
DB_PASSWORD=senha

BROADCAST_DRIVER=log
CACHE_DRIVER=file
FILESYSTEM_DRIVER=public
QUEUE_CONNECTION=sync
SESSION_DRIVER=file
SESSION_LIFETIME=120
EOF

# README.md
cat > "$BASE_DIR/README.md" <<'EOF'
# Projeto APS - Sistema em Laravel

## Requisitos
- PHP 8.1+
- Composer
- MySQL/Postgres/SQL Server
- Node.js (opcional para assets)





# routes/web.php
mkdir -p "$BASE_DIR/routes"
cat > "$BASE_DIR/routes/web.php" <<'EOF'
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ItemController;

Route::get('/', function () {
    return redirect()->route('items.index');
});

Route::resource('items', ItemController::class);

// Se quiser proteger com login, habilite auth middleware e instale Breeze
// Route::resource('items', ItemController::class)->middleware('auth');
EOF

# app/Models/Item.php
mkdir -p "$BASE_DIR/app/Models"
cat > "$BASE_DIR/app/Models/Item.php" <<'EOF'
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Item extends Model
{
    use HasFactory;

    protected $fillable = [
        'title',
        'description',
        'category',
        'image_path',
    ];
}
EOF

# app/Http/Controllers/ItemController.php
mkdir -p "$BASE_DIR/app/Http/Controllers"
cat > "$BASE_DIR/app/Http/Controllers/ItemController.php" <<'EOF'
<?php

namespace App\Http\Controllers;

use App\Models\Item;
use Illuminate\Http\Request;
use App\Http\Requests\StoreItemRequest;
use App\Http\Requests\UpdateItemRequest;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Cookie;

class ItemController extends Controller
{
    // Se quiser exigir autenticação, descomente o construtor abaixo
    // public function __construct() { $this->middleware('auth'); }

    public function index(Request $request)
    {
        $items = Item::orderBy('created_at', 'desc')->paginate(10);
        $lastCategory = $request->cookie('last_category');
        return view('items.index', compact('items', 'lastCategory'));
    }

    public function create()
    {
        return view('items.create');
    }

    public function store(StoreItemRequest $request)
    {
        $data = $request->validated();

        if ($request->hasFile('image')) {
            $path = $request->file('image')->store('items', 'public');
            $data['image_path'] = $path;
        }

        $item = Item::create($data);

        Session::flash('success', 'Item criado com sucesso!');

        if (!empty($item->category)) {
            Cookie::queue('last_category', $item->category, 60*24*30);
        }

        return redirect()->route('items.index');
    }

    public function show(Item $item)
    {
        return view('items.show', compact('item'));
    }

    public function edit(Item $item)
    {
        return view('items.edit', compact('item'));
    }

    public function update(UpdateItemRequest $request, Item $item)
    {
        $data = $request->validated();

        if ($request->hasFile('image')) {
            if ($item->image_path && Storage::disk('public')->exists($item->image_path)) {
                Storage::disk('public')->delete($item->image_path);
            }
            $path = $request->file('image')->store('items', 'public');
            $data['image_path'] = $path;
        }

        $item->update($data);

        Session::flash('success', 'Item atualizado com sucesso!');

        if (!empty($item->category)) {
            Cookie::queue('last_category', $item->category, 60*24*30);
        }

        return redirect()->route('items.index');
    }

    public function destroy(Item $item)
    {
        if ($item->image_path && Storage::disk('public')->exists($item->image_path)) {
            Storage::disk('public')->delete($item->image_path);
        }

        $item->delete();

        Session::flash('success', 'Item removido com sucesso!');

        return redirect()->route('items.index');
    }
}
EOF

# app/Http/Requests/StoreItemRequest.php
mkdir -p "$BASE_DIR/app/Http/Requests"
cat > "$BASE_DIR/app/Http/Requests/StoreItemRequest.php" <<'EOF'
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreItemRequest extends FormRequest
{
    public function authorize()
    {
        return true;
    }

    public function rules()
    {
        return [
            'title' => 'required|string|max:255',
            'description' => 'nullable|string',
            'category' => 'nullable|string|max:100',
            'image' => 'nullable|image|mimes:jpeg,png,jpg|max:2048',
        ];
    }
}
EOF

# app/Http/Requests/UpdateItemRequest.php
cat > "$BASE_DIR/app/Http/Requests/UpdateItemRequest.php"